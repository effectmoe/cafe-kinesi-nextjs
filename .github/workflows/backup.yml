name: Automated Backup

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰
    - cron: '0 2 * * 0'  # æ¯é€±æ—¥æ›œæ—¥ã«è¿½åŠ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Create backup archive
        run: |
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          BACKUP_NAME="backup_${TIMESTAMP}"

          echo "ğŸ“¦ Creating backup: $BACKUP_NAME"

          # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          mkdir -p backups

          tar -czf "backups/${BACKUP_NAME}.tar.gz" \
            --exclude=node_modules \
            --exclude=.next \
            --exclude=.git \
            --exclude=backups \
            src/ \
            public/ \
            schemas/ \
            package.json \
            package-lock.json \
            next.config.ts \
            tsconfig.json \
            .env.example

          echo "âœ… Backup created successfully"

      - name: Upload to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ github.run_number }}
          name: Backup ${{ github.run_number }} - ${{ github.event.repository.updated_at }}
          body: |
            ## è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

            - **æ—¥æ™‚**: ${{ github.event.repository.updated_at }}
            - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            - **å®Ÿè¡Œç•ªå·**: ${{ github.run_number }}

            ### ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å†…å®¹
            - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆsrc/ï¼‰
            - å…¬é–‹ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆpublic/ï¼‰
            - ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆschemas/ï¼‰
            - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
          files: backups/*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old backups
        run: |
          # 30æ—¥ä»¥ä¸Šå¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤
          echo "ğŸ§¹ Cleaning up old backups..."

          # GitHubãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—ã—ã¦å‰Šé™¤
          gh release list --limit 100 | grep "backup-" | tail -n +31 | cut -f1 | while read -r tag; do
            echo "Deleting old backup: $tag"
            gh release delete "$tag" -y
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sanity backup
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
        run: |
          echo "ğŸ“Š Backing up Sanity data..."

          # Sanity CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g @sanity/cli

          # ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

          sanity dataset export production "./backups/sanity_backup_${TIMESTAMP}.tar.gz" \
            --project $SANITY_PROJECT_ID \
            --token $SANITY_AUTH_TOKEN || echo "Sanity backup skipped (token not configured)"

      - name: Create backup report
        run: |
          cat > backup_report.md << EOF
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ¬ãƒãƒ¼ãƒˆ

          ## å®Ÿè¡Œæƒ…å ±
          - **æ—¥æ™‚**: $(date)
          - **å®Ÿè¡ŒID**: ${{ github.run_id }}
          - **ãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.repository }}

          ## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—çµ±è¨ˆ
          - **ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $(find src public schemas -type f | wc -l)
          - **ã‚³ãƒ¼ãƒ‰è¡Œæ•°**: $(find src -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1)
          - **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µã‚¤ã‚º**: $(du -sh backups/*.tar.gz | cut -f1)

          ## å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
          \`\`\`
          $(tar -tzf backups/*.tar.gz | head -20)
          ... and more
          \`\`\`

          ## æ¬¡å›ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          - æ—¥æ¬¡: æ˜æ—¥ã®åˆå‰2æ™‚ï¼ˆUTCï¼‰
          - é€±æ¬¡: æ¬¡ã®æ—¥æ›œæ—¥
          EOF

          echo "ğŸ“ Backup report created"

      - name: Send notification
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¤±æ•—',
              body: `## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼\n\n- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${context.workflow}\n- å®Ÿè¡ŒID: ${context.runId}\n- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»: ${new Date().toISOString()}`,
              labels: ['backup', 'error']
            });