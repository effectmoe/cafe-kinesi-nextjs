name: Uptime Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # 15åˆ†ã”ã¨
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Check site availability
        id: health
        run: |
          SITE_URL="https://cafekinesi-nextjs.vercel.app"
          API_HEALTH="${SITE_URL}/api/health"

          echo "ðŸ” Checking site availability..."

          # ãƒ¡ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒã‚§ãƒƒã‚¯
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" "$SITE_URL")

          echo "Main site status: $HTTP_STATUS"
          echo "Response time: ${RESPONSE_TIME}s"

          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_HEALTH")

          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "âŒ Site is down! Status: $HTTP_STATUS"
            echo "status=down" >> $GITHUB_OUTPUT
            echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT
            exit 1
          fi

          if (( $(echo "$RESPONSE_TIME > 5" | bc -l) )); then
            echo "âš ï¸ Site is slow! Response time: ${RESPONSE_TIME}s"
            echo "status=slow" >> $GITHUB_OUTPUT
            echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          else
            echo "âœ… Site is healthy"
            echo "status=up" >> $GITHUB_OUTPUT
            echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          fi

      - name: Check multiple endpoints
        id: endpoints
        run: |
          declare -a ENDPOINTS=(
            "/"
            "/blog"
            "/about"
            "/api/health"
            "/sitemap.xml"
            "/robots.txt"
          )

          FAILED_ENDPOINTS=""

          for endpoint in "${ENDPOINTS[@]}"; do
            URL="https://cafekinesi-nextjs.vercel.app${endpoint}"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")

            if [ "$STATUS" == "200" ] || [ "$STATUS" == "304" ]; then
              echo "âœ… $endpoint: $STATUS"
            else
              echo "âŒ $endpoint: $STATUS"
              FAILED_ENDPOINTS="${FAILED_ENDPOINTS}${endpoint} (${STATUS}), "
            fi
          done

          if [ -n "$FAILED_ENDPOINTS" ]; then
            echo "failed_endpoints=$FAILED_ENDPOINTS" >> $GITHUB_OUTPUT
          fi

      - name: Check SSL certificate
        run: |
          echo "ðŸ”’ Checking SSL certificate..."

          DOMAIN="cafekinesi-nextjs.vercel.app"

          # SSLè¨¼æ˜Žæ›¸ã®æœ‰åŠ¹æœŸé™ã‚’ç¢ºèª
          EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d= -f2)
          EXPIRY_TIMESTAMP=$(date -d "$EXPIRY_DATE" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_TIMESTAMP - $CURRENT_TIMESTAMP) / 86400 ))

          echo "SSL certificate expires in $DAYS_LEFT days"

          if [ $DAYS_LEFT -lt 7 ]; then
            echo "âš ï¸ SSL certificate expires soon!"
            echo "ssl_warning=true" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if site is down
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const now = new Date().toISOString();

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ ã‚µã‚¤ãƒˆãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™',
              body: `## ã‚¢ãƒ©ãƒ¼ãƒˆ

              ã‚µã‚¤ãƒˆãŒå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚

              - **URL**: https://cafekinesi-nextjs.vercel.app
              - **æ¤œå‡ºæ™‚åˆ»**: ${now}
              - **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.health.outputs.http_status || 'Unknown' }}
              - **å¤±æ•—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: ${{ steps.endpoints.outputs.failed_endpoints || 'None' }}

              ### å¯¾å¿œæ‰‹é †
              1. Vercelãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèª
              2. ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèª
              3. ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
              4. æœ€è¿‘ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèª

              [Vercel Dashboard](https://vercel.com/dashboard)
              `,
              labels: ['critical', 'monitoring', 'downtime']
            });

      - name: Performance metrics logging
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

          cat >> monitoring.log << EOF
          {
            "timestamp": "$TIMESTAMP",
            "status": "${{ steps.health.outputs.status }}",
            "response_time": "${{ steps.health.outputs.response_time }}",
            "http_status": "${{ steps.health.outputs.http_status }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF

          echo "ðŸ“Š Metrics logged"

      - name: Notification webhook (optional)
        if: failure()
        continue-on-error: true
        run: |
          # Slackã€Discordã€ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãªã©ã®Webhook
          # WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
          if [ -n "${{ secrets.MONITORING_WEBHOOK_URL }}" ]; then
            curl -X POST ${{ secrets.MONITORING_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "ðŸš¨ Cafe Kinesi ã‚µã‚¤ãƒˆãŒãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™",
                "status": "${{ steps.health.outputs.status }}",
                "url": "https://cafekinesi-nextjs.vercel.app"
              }'
          fi